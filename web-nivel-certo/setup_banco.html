<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração do Banco - ERP Água</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-database-gear"></i> 
                            Configuração do Banco de Dados - ERP Água
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Atenção:</strong> Esta operação irá executar o novo schema do banco de dados.
                            Certifique-se de ter backup dos dados importantes antes de continuar.
                        </div>

                        <div id="alerts"></div>

                        <div class="row">
                            <div class="col-md-6">
                                <h5>Opções de Configuração:</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipoConfig" id="configCompleta" value="completa" checked>
                                    <label class="form-check-label" for="configCompleta">
                                        <strong>Configuração Completa</strong><br>
                                        <small class="text-muted">Executa o script completo com dados de exemplo</small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="tipoConfig" id="configEstrutura" value="estrutura">
                                    <label class="form-check-label" for="configEstrutura">
                                        <strong>Apenas Estrutura</strong><br>
                                        <small class="text-muted">Executa apenas as tabelas, sem dados de exemplo</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Informações do Schema:</h5>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check text-success"></i> Tabela reservatorios</li>
                                    <li><i class="bi bi-check text-success"></i> Tabela dispositivos</li>
                                    <li><i class="bi bi-check text-success"></i> Tabela medicoes</li>
                                    <li><i class="bi bi-check text-success"></i> Tabela clientes</li>
                                    <li><i class="bi bi-check text-success"></i> Tabela notificacoes</li>
                                    <li><i class="bi bi-check text-success"></i> Tabela ordens_servico</li>
                                    <li><i class="bi bi-check text-success"></i> Dados de exemplo incluídos</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-primary btn-lg" onclick="executarConfiguracao()">
                                <i class="bi bi-play-circle"></i> Executar Configuração
                            </button>
                            <button class="btn btn-outline-secondary btn-lg ms-2" onclick="verificarStatus()">
                                <i class="bi bi-info-circle"></i> Verificar Status
                            </button>
                        </div>

                        <div class="mt-4" id="resultadoContainer" style="display: none;">
                            <h5>Resultado da Execução:</h5>
                            <div class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                <pre id="resultadoOutput"></pre>
                            </div>
                        </div>

                        <div class="mt-4" id="progressContainer" style="display: none;">
                            <h5>Progresso:</h5>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
                            </div>
                            <div class="mt-2" id="progressText">Iniciando...</div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check"></i> 
                            Script SQL (Prévia)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                            <pre id="previewSQL" style="font-size: 12px;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Carregar prévia do SQL ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            carregarPreviewSQL();
        });

        // Carregar prévia do SQL
        async function carregarPreviewSQL() {
            try {
                const response = await fetch('sql/init_simples_v2.sql');
                const sqlContent = await response.text();
                
                // Mostrar apenas as primeiras 50 linhas para prévia
                const lines = sqlContent.split('\n');
                const preview = lines.slice(0, 50).join('\n');
                document.getElementById('previewSQL').textContent = preview + '\n... (arquivo completo será executado)';
            } catch (error) {
                document.getElementById('previewSQL').textContent = 'Erro ao carregar prévia do SQL: ' + error.message;
            }
        }

        // Executar configuração
        async function executarConfiguracao() {
            const tipoConfig = document.querySelector('input[name="tipoConfig"]:checked').value;
            
            if (!confirm('Tem certeza que deseja executar a configuração do banco? Esta operação pode sobrescrever dados existentes.')) {
                return;
            }

            mostrarProgress();
            
            try {
                atualizarProgress(20, 'Carregando script SQL...');
                
                // Carregar o script SQL
                const response = await fetch('sql/init_simples_v2.sql');
                const sqlContent = await response.text();
                
                // Preparar comandos SQL
                atualizarProgress(40, 'Preparando comandos...');
                
                // Processar SQL de forma mais inteligente
                let sqlProcessado = sqlContent
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n');
                
                // Dividir por linhas e processar
                let linhas = sqlProcessado.split('\n');
                let comandos = [];
                let comandoAtual = '';
                
                for (let linha of linhas) {
                    linha = linha.trim();
                    
                    // Pular linhas vazias e comentários
                    if (!linha || linha.startsWith('--') || linha.startsWith('#') || linha.startsWith('/*')) {
                        continue;
                    }
                    
                    comandoAtual += linha + '\n';
                    
                    // Se a linha termina com ;, é o fim de um comando
                    if (linha.endsWith(';')) {
                        let comando = comandoAtual.trim();
                        if (comando) {
                            comandos.push(comando);
                        }
                        comandoAtual = '';
                    }
                }
                
                // Se sobrou algum comando sem ;
                if (comandoAtual.trim()) {
                    comandos.push(comandoAtual.trim());
                }
                
                console.log('Comandos processados:', comandos.length);
                
                // Se for apenas estrutura, filtrar apenas comandos de criação
                if (tipoConfig === 'estrutura') {
                    comandos = comandos.filter(cmd => {
                        const cmdUpper = cmd.toUpperCase().trim();
                        return cmdUpper.includes('CREATE') || 
                               cmdUpper.includes('DROP') || 
                               cmdUpper.includes('USE ') ||
                               cmdUpper.includes('SET ');
                    });
                }
                
                atualizarProgress(60, 'Executando comandos SQL...');
                
                // Executar via API
                const execResponse = await fetch('api/executar_sql_v3.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comandos: comandos,
                        tipo: tipoConfig
                    })
                });
                
                const responseText = await execResponse.text();
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('Resposta bruta do servidor:', responseText);
                    throw new Error('Resposta inválida do servidor. Verifique o console para detalhes.');
                }
                
                atualizarProgress(100, 'Concluído!');
                
                setTimeout(() => {
                    esconderProgress();
                    mostrarResultado(result);
                }, 1000);
                
            } catch (error) {
                console.error('Erro na configuração:', error);
                esconderProgress();
                
                let errorMessage = 'Erro na configuração: ' + error.message;
                
                // Se for erro de JSON, explicar melhor
                if (error.message.includes('Unexpected token') || error.message.includes('JSON')) {
                    errorMessage = 'Erro na resposta do servidor. Verifique se não há erros de PHP no servidor. Detalhes: ' + error.message;
                }
                
                mostrarAlerta(errorMessage, 'danger');
            }
        }

        // Verificar status do banco
        async function verificarStatus() {
            try {
                const response = await fetch('api/verificar_banco.php');
                const result = await response.json();
                
                let statusHtml = '<h6>Status das Tabelas:</h6><ul>';
                
                if (result.success && result.tabelas) {
                    result.tabelas.forEach(tabela => {
                        const icon = tabela.existe ? 
                            '<i class="bi bi-check-circle text-success"></i>' : 
                            '<i class="bi bi-x-circle text-danger"></i>';
                        statusHtml += `<li>${icon} ${tabela.nome} ${tabela.existe ? `(${tabela.registros} registros)` : '(não existe)'}</li>`;
                    });
                } else {
                    statusHtml += '<li><i class="bi bi-exclamation-triangle text-warning"></i> Erro ao verificar status</li>';
                }
                
                statusHtml += '</ul>';
                
                document.getElementById('resultadoContainer').style.display = 'block';
                document.getElementById('resultadoOutput').innerHTML = statusHtml;
                
            } catch (error) {
                mostrarAlerta('Erro ao verificar status: ' + error.message, 'danger');
            }
        }

        // Mostrar progress
        function mostrarProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultadoContainer').style.display = 'none';
        }

        // Esconder progress
        function esconderProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        // Atualizar progress
        function atualizarProgress(porcentagem, texto) {
            document.getElementById('progressBar').style.width = porcentagem + '%';
            document.getElementById('progressText').textContent = texto;
        }

        // Mostrar resultado
        function mostrarResultado(result) {
            document.getElementById('resultadoContainer').style.display = 'block';
            
            let output = '';
            if (result.success) {
                output = `✅ CONFIGURAÇÃO CONCLUÍDA COM SUCESSO!\n\n`;
                output += `Comandos executados: ${result.comandos_executados || 0}\n`;
                output += `Tempo de execução: ${result.tempo || 'N/A'}\n\n`;
                
                if (result.detalhes && result.detalhes.length > 0) {
                    output += `Detalhes:\n`;
                    result.detalhes.forEach(detalhe => {
                        output += `- ${detalhe}\n`;
                    });
                }
                
                mostrarAlerta('Configuração executada com sucesso!', 'success');
            } else {
                output = `❌ ERRO NA CONFIGURAÇÃO!\n\n`;
                output += `Erro: ${result.message}\n\n`;
                
                if (result.erros && result.erros.length > 0) {
                    output += `Detalhes dos erros:\n`;
                    result.erros.forEach(erro => {
                        output += `- ${erro}\n`;
                    });
                }
                
                mostrarAlerta('Erro na configuração: ' + result.message, 'danger');
            }
            
            document.getElementById('resultadoOutput').textContent = output;
        }

        // Mostrar alerta
        function mostrarAlerta(mensagem, tipo) {
            const alertsContainer = document.getElementById('alerts');
            const alertId = 'alert_' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert" id="${alertId}">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertsContainer.innerHTML = alertHtml;
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
