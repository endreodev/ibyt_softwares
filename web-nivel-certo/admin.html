<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBYT Water Level - ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            z-index: 1001;
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 0;
            margin: 2px 10px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
        }
        
        .card-stat {
            border: none;
            border-radius: 15px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .card-stat:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .bg-primary-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-success-gradient { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .bg-warning-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .bg-info-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        .top-header {
            position: fixed;
            top: 0;
            right: 0;
            left: 250px;
            height: 50px;
            background: linear-gradient(90deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .content-wrapper {
            margin-left: 250px;
            margin-top: 50px;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .content-wrapper {
                margin-left: 0;
                margin-top: 50px;
            }
            .sidebar {
                display: none;
            }
            .top-header {
                left: 0;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .btn-action {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Header com botão de logout -->
    <div class="top-header">
        <div class="d-flex justify-content-between align-items-center px-3 h-100">
            <div class="d-flex align-items-center">
                <span class="status-indicator" title="Sistema Online"></span>
                <i class="fas fa-tint text-primary me-2"></i>
                <span class="fw-bold text-dark">ERP Nível de Água</span>
            </div>
            <div class="d-flex align-items-center">
                <span class="me-3 text-muted small" id="userInfo">
                    <i class="fas fa-user me-1"></i>
                    Carregando...
                </span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()" title="Sair do sistema">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Sair
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar position-fixed">
        <div class="text-center py-4">
            <h4 class="text-white">IBYT Water Level</h4>
            <small class="text-white-50">Sistema ERP</small>
        </div>
        
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="loadDashboard()">
                    <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="loadClientes()">
                    <i class="fas fa-building me-2"></i> Clientes
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="gestao_reservatorios.html">
                    <i class="fas fa-tint me-2"></i> Reservatórios
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="loadDispositivos()">
                    <i class="fas fa-microchip me-2"></i> Dispositivos
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="teste_medicao.html">
                    <i class="fas fa-flask me-2"></i> Teste IoT
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="setup_banco.html">
                    <i class="fas fa-database me-2"></i> Config. Banco
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="loadAssinaturas()">
                    <i class="fas fa-file-contract me-2"></i> Assinaturas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="loadFaturas()">
                    <i class="fas fa-file-invoice-dollar me-2"></i> Faturas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="loadOrdensServico()">
                    <i class="fas fa-tools me-2"></i> Ordens de Serviço
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="loadRelatorios()">
                    <i class="fas fa-chart-bar me-2"></i> Relatórios
                </a>
            </li>
        </ul>
    </div>

    <!-- Content -->
    <div class="content-wrapper">
        <div id="content">
            <!-- Dashboard será carregado aqui -->
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </div>

    <!-- Modal genérico -->
    <div class="modal fade" id="genericModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Conteúdo será inserido dinamicamente -->
                </div>
                <div class="modal-footer" id="modalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Verificar autenticação
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const userData = localStorage.getItem('user_data');
            
            if (!token || token === 'no_auth' || !userData) {
                console.log('Usuário não autenticado, redirecionando...');
                window.location.href = 'login.html';
                return false;
            }
            
            // Mostrar dados do usuário se disponível
            try {
                const user = JSON.parse(userData);
                console.log('Usuário logado:', user.usuario || user.email);
                
                // Atualizar informações do usuário no header
                const userInfo = document.getElementById('userInfo');
                if (userInfo) {
                    const nomeUsuario = user.nome || user.usuario || user.email;
                    const tipoUsuario = user.tipo || 'usuário';
                    
                    userInfo.innerHTML = `
                        <i class="fas fa-user me-1"></i>
                        <span class="fw-semibold">${nomeUsuario}</span>
                        <small class="text-muted ms-1">(${tipoUsuario})</small>
                    `;
                }
                
            } catch (e) {
                console.error('Erro ao ler dados do usuário:', e);
                // Se os dados estão corrompidos, fazer logout
                logout();
                return false;
            }
            
            return true;
        }
        
        // Função de logout
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                // Limpar dados de autenticação
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_data');
                
                // Fazer logout no servidor (opcional)
                fetch('api/logout.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(() => {
                    // Ignorar erros na chamada de logout
                }).finally(() => {
                    // Redirecionar para login
                    window.location.href = 'login.html';
                });
            }
        }
        
        // API Base URL
        const API_BASE = 'api/';
        
        // Utilitários
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            alert('Erro: ' + message);
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }
        
        // Função para fazer requisições à API
        async function apiRequest(endpoint, options = {}) {
            showLoading(true);
            
            // Adicionar token de autenticação
            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                headers['X-Auth-Token'] = token;
            }
            
            try {
                const response = await fetch(API_BASE + endpoint, {
                    headers: headers,
                    ...options
                });
                
                // Verificar se a resposta é válida
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                
                // Tentar parsear como JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (jsonError) {
                    console.error('Resposta não é JSON válido:', text);
                    throw new Error('Resposta inválida do servidor. Verifique o console para detalhes.');
                }
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro na requisição');
                }
                
                return data;
            } catch (error) {
                console.error('Erro na API:', error);
                showError(error.message);
                throw error;
            } finally {
                showLoading(false);
            }
        }
        
        // Carregar Dashboard
        async function loadDashboard() {
            try {
                const data = await apiRequest('dashboard_simples.php?action=admin');
                const stats = data.data;
                
                document.getElementById('content').innerHTML = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2>Dashboard Administrativo</h2>
                            <p class="text-muted">Visão geral do sistema de monitoramento</p>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card card-stat bg-primary-gradient text-white">
                                <div class="card-body d-flex align-items-center">
                                    <div class="stat-icon bg-primary-gradient me-3">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title">${stats.estatisticas.total_clientes}</h5>
                                        <p class="card-text mb-0">Clientes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card card-stat bg-success-gradient text-white">
                                <div class="card-body d-flex align-items-center">
                                    <div class="stat-icon bg-success-gradient me-3">
                                        <i class="fas fa-microchip"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title">${stats.estatisticas.total_dispositivos}</h5>
                                        <p class="card-text mb-0">Dispositivos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card card-stat bg-info-gradient text-white">
                                <div class="card-body d-flex align-items-center">
                                    <div class="stat-icon bg-info-gradient me-3">
                                        <i class="fas fa-tint"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title">${stats.estatisticas.total_reservatorios}</h5>
                                        <p class="card-text mb-0">Reservatórios</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card card-stat bg-warning-gradient text-white">
                                <div class="card-body d-flex align-items-center">
                                    <div class="stat-icon bg-warning-gradient me-3">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title">${stats.estatisticas.medicoes_hoje}</h5>
                                        <p class="card-text mb-0">Medições Hoje</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Últimas Medições</h5>
                                </div>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    ${stats.listas.ultimas_medicoes.length > 0 ? 
                                        stats.listas.ultimas_medicoes.map(medicao => `
                                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                                                <div>
                                                    <strong>${medicao.identificador || 'Dispositivo ' + medicao.dispositivo_id}</strong><br>
                                                    <small class="text-muted">${medicao.nome_fantasia || 'Cliente não identificado'}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge ${medicao.nivel_agua < 20 ? 'bg-danger' : medicao.nivel_agua > 80 ? 'bg-success' : 'bg-warning'}">${medicao.nivel_agua}%</span><br>
                                                    <small class="text-muted">${new Date(medicao.data_hora).toLocaleString('pt-BR')}</small>
                                                </div>
                                            </div>
                                        `).join('') 
                                        : '<p class="text-muted">Nenhuma medição encontrada</p>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Alertas Recentes</h5>
                                </div>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    ${stats.listas.alertas.length > 0 ? 
                                        stats.listas.alertas.map(alerta => `
                                            <div class="alert alert-warning mb-2">
                                                <strong>${alerta.identificador || 'Dispositivo ' + alerta.dispositivo_id}</strong><br>
                                                <small>${alerta.nome_fantasia || 'Cliente não identificado'}</small><br>
                                                Nível: <strong>${alerta.nivel_agua}%</strong> 
                                                <span class="badge ${alerta.nivel_agua < 20 ? 'bg-danger' : 'bg-warning'}">
                                                    ${alerta.nivel_agua < 20 ? 'Crítico' : 'Transbordando'}
                                                </span><br>
                                                <small class="text-muted">${new Date(alerta.data_hora).toLocaleString('pt-BR')}</small>
                                            </div>
                                        `).join('') 
                                        : '<p class="text-muted">Nenhum alerta no momento</p>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Clientes por Cidade</h5>
                                </div>
                                <div class="card-body">
                                    ${stats.graficos.clientes_por_cidade.length > 0 ? 
                                        stats.graficos.clientes_por_cidade.map(item => `
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>${item.cidade}</span>
                                                <span class="badge bg-primary">${item.total}</span>
                                            </div>
                                        `).join('') 
                                        : '<p class="text-muted">Nenhum dado disponível</p>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                showLoading(false);
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                document.getElementById('content').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Erro ao carregar dashboard</h4>
                        <p>Detalhes: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadDashboard()">Tentar novamente</button>
                    </div>
                `;
                showLoading(false);
            }
        }

        // Carregar Clientes
        async function loadClientes() {
            try {
                const data = await apiRequest('clientes.php?action=listar');

                let clientesHtml = `
                    <div class="row mb-4">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <h2>Gestão de Clientes</h2>
                            <button class="btn btn-primary" onclick="novoCliente()">
                                <i class="fas fa-plus"></i> Novo Cliente
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nome Fantasia</th>
                                            <th>CNPJ</th>
                                            <th>Status</th>
                                            <th>Dispositivos</th>
                                            <th>Reservatórios</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;

                data.data.forEach(cliente => {
                    clientesHtml += `
                        <tr>
                            <td>${cliente.nome_fantasia}</td>
                            <td>${cliente.cnpj_formatado}</td>
                            <td><span class="badge bg-${getStatusColor(cliente.status)}">${cliente.status_texto}</span></td>
                            <td>${cliente.total_dispositivos}</td>
                            <td>${cliente.total_reservatorios}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editarCliente(${cliente.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="verCliente(${cliente.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                clientesHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('content').innerHTML = clientesHtml;
                updateNavigation('clientes');

            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                document.getElementById('content').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Erro ao carregar clientes</h4>
                        <p>Detalhes: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadClientes()">Tentar novamente</button>
                    </div>
                `;  
            }
        }
        
        // Carregar Clientes
        async function loadClientes() {
            try {
                const data = await apiRequest('clientes.php?action=listar');
                
                let clientesHtml = `
                    <div class="row mb-4">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <h2>Gestão de Clientes</h2>
                            <button class="btn btn-primary" onclick="novoCliente()">
                                <i class="fas fa-plus"></i> Novo Cliente
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nome Fantasia</th>
                                            <th>CNPJ</th>
                                            <th>Status</th>
                                            <th>Dispositivos</th>
                                            <th>Reservatórios</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.data.forEach(cliente => {
                    clientesHtml += `
                        <tr>
                            <td>${cliente.nome_fantasia}</td>
                            <td>${cliente.cnpj_formatado}</td>
                            <td><span class="badge bg-${getStatusColor(cliente.status)}">${cliente.status_texto}</span></td>
                            <td>${cliente.total_dispositivos}</td>
                            <td>${cliente.total_reservatorios}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editarCliente(${cliente.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="verCliente(${cliente.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                clientesHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = clientesHtml;
                updateNavigation('clientes');
                
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }
        
        // Carregar Dispositivos
        async function loadDispositivos() {
            try {
                const data = await apiRequest('dispositivos.php?action=listar');
                
                let dispositivosHtml = `
                    <div class="row mb-4">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <h2>Gestão de Dispositivos</h2>
                            <button class="btn btn-primary" onclick="novoDispositivo()">
                                <i class="fas fa-plus"></i> Novo Dispositivo
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Código Série</th>
                                            <th>Cliente</th>
                                            <th>Modelo</th>
                                            <th>Status</th>
                                            <th>Última Comunicação</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.data.forEach(dispositivo => {
                    dispositivosHtml += `
                        <tr>
                            <td>${dispositivo.codigo_serie}</td>
                            <td>${dispositivo.cliente_nome || 'N/A'}</td>
                            <td>${dispositivo.modelo}</td>
                            <td><span class="badge bg-${getStatusColor(dispositivo.status)}">${dispositivo.status_texto}</span></td>
                            <td>${dispositivo.ultima_comunicacao ? formatDate(dispositivo.ultima_comunicacao) : 'Nunca'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editarDispositivo(${dispositivo.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="verDispositivo(${dispositivo.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                dispositivosHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = dispositivosHtml;
                updateNavigation('dispositivos');
                
            } catch (error) {
                console.error('Erro ao carregar dispositivos:', error);
            }
        }
        
        // Carregar Assinaturas
        async function loadAssinaturas() {
            try {
                const data = await apiRequest('assinaturas.php?action=listar_assinaturas');
                
                let assinaturasHtml = `
                    <div class="row mb-4">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <h2>Gestão de Assinaturas</h2>
                            <button class="btn btn-primary" onclick="novaAssinatura()">
                                <i class="fas fa-plus"></i> Nova Assinatura
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Plano</th>
                                            <th>Valor Mensal</th>
                                            <th>Status</th>
                                            <th>Data Início</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.data.forEach(assinatura => {
                    assinaturasHtml += `
                        <tr>
                            <td>${assinatura.cliente_nome}</td>
                            <td>${assinatura.plano_nome}</td>
                            <td>${assinatura.valor_formatado}</td>
                            <td><span class="badge bg-${getStatusColor(assinatura.status)}">${assinatura.status_texto}</span></td>
                            <td>${formatDate(assinatura.data_inicio)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editarAssinatura(${assinatura.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="verAssinatura(${assinatura.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                assinaturasHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = assinaturasHtml;
                updateNavigation('assinaturas');
                
            } catch (error) {
                console.error('Erro ao carregar assinaturas:', error);
            }
        }
        
        // Carregar Faturas
        async function loadFaturas() {
            try {
                const data = await apiRequest('assinaturas.php?action=listar_faturas');
                
                let faturasHtml = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2>Gestão de Faturas</h2>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Cliente</th>
                                            <th>Valor</th>
                                            <th>Vencimento</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.data.forEach(fatura => {
                    faturasHtml += `
                        <tr>
                            <td>${fatura.numero_fatura}</td>
                            <td>${fatura.cliente_nome}</td>
                            <td>${fatura.valor_formatado}</td>
                            <td>${fatura.data_vencimento_formatada}</td>
                            <td><span class="badge bg-${getStatusColor(fatura.status)}">${fatura.status_texto}</span></td>
                            <td>
                                <button class="btn btn-sm btn-success btn-action" onclick="marcarComoPaga(${fatura.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="verFatura(${fatura.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                faturasHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = faturasHtml;
                updateNavigation('faturas');
                
            } catch (error) {
                console.error('Erro ao carregar faturas:', error);
            }
        }
        
        // Carregar Ordens de Serviço
        async function loadOrdensServico() {
            try {
                const data = await apiRequest('ordens_servico.php?action=listar');
                
                let ordensHtml = `
                    <div class="row mb-4">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <h2>Ordens de Serviço</h2>
                            <button class="btn btn-primary" onclick="novaOS()">
                                <i class="fas fa-plus"></i> Nova OS
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Número OS</th>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Status</th>
                                            <th>Técnico</th>
                                            <th>Data Abertura</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.data.forEach(os => {
                    ordensHtml += `
                        <tr>
                            <td>${os.numero_os}</td>
                            <td>${os.cliente_nome}</td>
                            <td>${os.tipo_texto}</td>
                            <td><span class="badge bg-${getStatusColor(os.status)}">${os.status_texto}</span></td>
                            <td>${os.tecnico_nome || 'Não atribuído'}</td>
                            <td>${os.data_abertura_formatada}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editarOS(${os.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="verOS(${os.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                ordensHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = ordensHtml;
                updateNavigation('ordens');
                
            } catch (error) {
                console.error('Erro ao carregar ordens de serviço:', error);
            }
        }
        
        // Carregar Relatórios
        function loadRelatorios() {
            document.getElementById('content').innerHTML = `
                <div class="row mb-4">
                    <div class="col-12">
                        <h2>Relatórios</h2>
                        <p class="text-muted">Área de relatórios em desenvolvimento</p>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Receita por Período</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="receitaChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>Dispositivos por Status</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="dispositivosChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            updateNavigation('relatorios');
        }
        
        // Utilitários de status
        function getStatusColor(status) {
            const colors = {
                'ativo': 'success',
                'ativa': 'success',
                'paga': 'success',
                'concluida': 'success',
                'suspenso': 'warning',
                'suspensa': 'warning',
                'pendente': 'warning',
                'em_andamento': 'info',
                'cancelado': 'danger',
                'cancelada': 'danger',
                'vencida': 'danger',
                'defeito': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        // Atualizar navegação ativa
        function updateNavigation(active) {
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeMap = {
                'dashboard': 0,
                'clientes': 1,
                'dispositivos': 2,
                'assinaturas': 3,
                'faturas': 4,
                'ordens': 5,
                'relatorios': 6
            };
            
            const index = activeMap[active];
            if (index !== undefined) {
                document.querySelectorAll('.sidebar .nav-link')[index].classList.add('active');
            }
        }
        
        // Funções placeholder para ações
        function novoCliente() { alert('Funcionalidade em desenvolvimento'); }
        function editarCliente(id) { alert('Editar cliente ' + id); }
        function verCliente(id) { alert('Ver cliente ' + id); }
        function novoDispositivo() { alert('Funcionalidade em desenvolvimento'); }
        function editarDispositivo(id) { alert('Editar dispositivo ' + id); }
        function verDispositivo(id) { alert('Ver dispositivo ' + id); }
        function novaAssinatura() { alert('Funcionalidade em desenvolvimento'); }
        function editarAssinatura(id) { alert('Editar assinatura ' + id); }
        function verAssinatura(id) { alert('Ver assinatura ' + id); }
        function marcarComoPaga(id) { alert('Marcar fatura ' + id + ' como paga'); }
        function verFatura(id) { alert('Ver fatura ' + id); }
        function novaOS() { alert('Funcionalidade em desenvolvimento'); }
        function editarOS(id) { alert('Editar OS ' + id); }
        function verOS(id) { alert('Ver OS ' + id); }
        
        // Carregar dashboard ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação primeiro
            if (checkAuth()) {
                loadDashboard();
            }
        });
    </script>
</body>
</html>
